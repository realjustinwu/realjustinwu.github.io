---
title: 博客优化
date: 2018-04-27 22:25:27
categories: 小工具
tags: [hexo, Gogs, Linux, Cron]
blog: true
---



从博客搭建完到现在，一年多了，写的博客特别少。其中一个原因是忙，另一个更重要的原因是，写博客和发布都比较繁琐，需要记很多命令。
写博客使用 `hexo new title`, 博客写完之后，使用 `hexo g; hexo d` 生成和部署博客。之前没有使用 ssh-key 还需要输入密码，so 不想写博客是真的有原因的。

最近两周，总算抽出点时间，把博客重新优化了一下。

<!-- more -->

### 写博客到发布流程对比

博客优化前的博客生成流程是：

- 本地用 markdown 写博客
- 写完之后，本地使用 hexo 生成静态页面
- 然后将静态页 push 到 VPS，VPS 只是简单的一个 apache 服务

优化之后的博客生成流程是：

- 本地使用 markdown 写博客
- 直接 push 到 VPS 中的仓库中
- VPS 每天从仓库中拉取最新内容，使用 hexo 生成静态页面
- 将静态页面 mv 到 apache 目录

操作明显简化了，不需要命令行，不需要关心发布流程，只要把 markdown 文件 push 到服务器，跟平常写代码一个样。

##步骤

1. 在 VPS 中创建 3 个用户，分别是：

    - my_name: 用于登录
    - apache: 用于部署 apache 服务
    - gogs:  轻量级 gitlab

2. 安装 apache

    略

3. 安装 gogs

    https://gogs.io/docs/installation/install_from_binary

    安装完成之后，创建仓库，创建用户，添加 rsa-key, 方便提交代码。

4. 安装 hexo

    参考: https://hexo.io/zh-cn/docs/

5. 配置定时任务

        # crontab -e
        SHELL=/bin/bash
        HOME=/
        PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
        MAILTO="my@email.com"
        00 22 * * * cd /home/apache/my_blog/; git pull; hexo clean; hexo g; cp -rf public/* /var/www/blog/
        # 每天晚上 10 点部署博客

6. 写博客

    hexo 写博客时，文章顶部需要 Front-matter，`hexo new title` 的时候会自动生成。
    但是我的习惯是，使用 Sublime 打开整个 blog 文件夹，用命令行 new 也是一件麻烦的事。
    然后把 Front-matter 模版拷贝到 Dash 中，做成快捷键 `blog\``。
    @date @time 的格式是系统给的，可以在系统设置中改系统的格式。

        ---
        title: __placeholder__
        date: @date @time
        categories: Android\Java\NDK\源码阅读\小工具\其他\小游戏
        tags: []
        ---

### 各种坑

1. gogs 的 hook 有问题

    花了几个小时没找出原因，然后忽略了。即使找到原因，hook 成功了，也没有权限把文件拷贝到 apache 用户下，即使拷过去了，还得考虑如何再哪个用户下运行 hexo 去生成静态页。最后的办法是，apache 中跑一个定时任务，任何问题都解决了。

2. 同一台机器通过 http 方式下载 git 仓库，一直提示没权限

    我的本地机器都能从 gogs 下载代码，同一个 VPS 下的不同用户 apache 使用 http 或者 ssh 的方式都下载不了仓库，一直报没权限。
    这就比较坑了，花了好长时间也没找到原因。最后，试了一下使用绝对路径的方式，直接 `git clone /home/gogs/blog...` 居然成功了。


